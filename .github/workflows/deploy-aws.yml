name: Deploy CRM via Docker Hub

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: hunderedacress/crm-100acress
  EC2_USER: ubuntu
  EC2_HOST: ${{ secrets.EC2_HOST }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Hub Login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | \
          docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build & Push Backend Image
        run: |
          docker build -t $IMAGE_NAME:backend ./crm-backend
          docker push $IMAGE_NAME:backend

      - name: Build & Push Frontend Image
        run: |
          docker build -t $IMAGE_NAME:frontend ./acre-flow-crm
          docker push $IMAGE_NAME:frontend

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Save EC2 SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 400 ec2_key.pem

      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem \
          $EC2_USER@$EC2_HOST << 'EOF'
            set -e

            echo "ðŸ”¹ Ensure Docker"
            if ! command -v docker &>/dev/null; then
              sudo apt update -y
              sudo apt install -y docker.io
              sudo systemctl enable --now docker
              sudo usermod -aG docker ubuntu
            fi

            echo "ðŸ”¹ Pull images"
            docker pull hunderedacress/crm-100acress:backend
            docker pull hunderedacress/crm-100acress:frontend

            echo "ðŸ”¹ Remove old containers"
            docker rm -f crm-backend crm-frontend || true

            echo "ðŸ”¹ Run backend"
            docker run -d \
              --name crm-backend \
              -p 5001:5001 \
              hunderedacress/crm-100acress:backend

            echo "ðŸ”¹ Run frontend"
            docker run -d \
              --name crm-frontend \
              -p 5000:80 \
              hunderedacress/crm-100acress:frontend


            docker image prune -f
            echo "âœ… DEPLOY SUCCESS"
          EOF

      - name: Cleanup
        run: rm -f ec2_key.pem
