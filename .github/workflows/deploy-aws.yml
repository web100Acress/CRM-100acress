name: Deploy CRM to EC2 (Docker)

on:
  push:
    branches:
      - main

env:
  EC2_USER: ubuntu
  EC2_HOST: 3.7.71.56
  PROJECT_DIR: /home/ubuntu/CRM-100acress

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Save SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 400 ec2_key.pem

      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e

            echo "ðŸ”¹ Ensure Docker"
            if ! command -v docker &>/dev/null; then
              sudo apt update -y
              sudo apt install -y docker.io
              sudo systemctl enable --now docker
              sudo usermod -aG docker ubuntu
            fi

            echo "ðŸ”¹ Prepare project"
            mkdir -p /home/ubuntu/CRM-100acress
            cd /home/ubuntu/CRM-100acress

            if [ ! -d ".git" ]; then
              git clone https://github.com/web100Acress/CRM-100acress.git .
            else
              git pull origin main
            fi

            echo "ðŸ”¹ Build Backend Image"
            docker build -t crm-backend ./crm-backend

            echo "ðŸ”¹ Build Frontend Image"
            docker build -t crm-frontend ./acre-flow-crm

            echo "ðŸ”¹ Restart containers"
            docker rm -f crm-backend crm-frontend || true

            docker run -d \
              --name crm-backend \
              -p 5001:5001 \
              crm-backend

            docker run -d \
              --name crm-frontend \
              -p 80:80 \
              crm-frontend

            docker image prune -f
            echo "âœ… DEPLOY DONE"
          EOF

      - name: Cleanup
        run: rm -f ec2_key.pem
