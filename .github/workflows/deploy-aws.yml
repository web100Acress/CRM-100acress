name: Deploy to AWS EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  EC2_INSTANCE_ID: i-0ef3eda6dd281400b

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 3ï¸âƒ£ Configure AWS credentials
    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # 4ï¸âƒ£ Prepare SSH key
    - name: Setup SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
        chmod 400 ec2_key.pem

    # 5ï¸âƒ£ Get EC2 public IP
    - name: Get EC2 Public IP
      id: ec2
      run: |
        PUBLIC_IP=$(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
        echo "EC2_PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_OUTPUT
        echo "EC2 IP: $PUBLIC_IP"

    # 6ï¸âƒ£ Wait for SSH to be ready
    - name: Wait for SSH
      run: |
        for i in {1..30}; do
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ec2_key.pem ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }} "echo SSH ready" &>/dev/null; then
            echo "SSH is ready!"
            break
          fi
          echo "Attempt $i/30: SSH not ready, waiting 10s..."
          sleep 10
        done

    # 7ï¸âƒ£ Deploy application
    - name: Deploy application
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        echo "ðŸš€ Starting deployment..."

        PROJECT_DIR=/var/www/crm

        # Create project directory if missing
        [ ! -d $PROJECT_DIR ] && mkdir -p $PROJECT_DIR && chown ubuntu:ubuntu $PROJECT_DIR

        cd $PROJECT_DIR

        # Clone repo if not exists, else pull latest changes
        if [ ! -d ".git" ]; then
          git clone https://github.com/web100Acress/CRM-100acress.git .
        else
          git pull origin main
        fi

        # Frontend build
        cd acre-flow-crm
        npm ci
        npm run build

        # Backend install
        cd ../crm-backend
        npm ci

        # PM2 restart/start
        cd $PROJECT_DIR
        pm2 install pm2-logrotate || true
        pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
        pm2 save

        # Restart Nginx
        sudo systemctl restart nginx

        echo "âœ… Deployment completed!"
        EOF

        # Copy and execute script on EC2
        scp -o StrictHostKeyChecking=no -i ec2_key.pem deploy.sh ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }}:/tmp/
        ssh -o StrictHostKeyChecking=no -i ec2_key.pem ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }} "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"

    # 8ï¸âƒ£ Health check
    - name: Health check
      run: |
        echo "ðŸ¥ Checking frontend..."
        curl -f -s http://${{ steps.ec2.outputs.EC2_PUBLIC_IP }} || (echo "Frontend down" && exit 1)
        echo "âœ… Frontend accessible"

        echo "ðŸ¥ Checking backend..."
        curl -f -s http://${{ steps.ec2.outputs.EC2_PUBLIC_IP }}/api || (echo "Backend down" && exit 1)
        echo "âœ… Backend accessible"

    # 9ï¸âƒ£ Cleanup
    - name: Cleanup
      run: rm -f ec2_key.pem deploy.sh

    # ðŸ”Ÿ Deployment summary
    - name: Deployment summary
      run: |
        echo "ðŸŽ‰ Deployment completed!"
        echo "ðŸŒ Frontend: http://${{ steps.ec2.outputs.EC2_PUBLIC_IP }}"
        echo "ðŸ”§ Backend: http://${{ steps.ec2.outputs.EC2_PUBLIC_IP }}/api"
        echo "ðŸ“Š PM2 Status: ssh -i ec2_key.pem ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }} 'pm2 status'"
