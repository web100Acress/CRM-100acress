name: Deploy to AWS EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  EC2_INSTANCE_ID: i-0ef3eda6dd281400b
  REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/web100Acress/CRM-100acress.git

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 3ï¸âƒ£ Configure AWS credentials
    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # 4ï¸âƒ£ Create SSH key for EC2
    - name: Setup SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
        chmod 400 ec2_key.pem

    # 5ï¸âƒ£ Get EC2 public IP
    - name: Get EC2 Public IP
      id: ec2
      run: |
        PUBLIC_IP=$(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
        echo "EC2_PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_OUTPUT
        echo "EC2 IP: $PUBLIC_IP"

    # 6ï¸âƒ£ Wait for SSH
    - name: Wait for SSH
      run: |
        for i in {1..30}; do
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ec2_key.pem ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }} "echo SSH ready" &>/dev/null; then
            echo "SSH is ready!"
            break
          fi
          echo "Attempt $i/30: SSH not ready, waiting 10s..."
          sleep 10
        done

    # 7ï¸âƒ£ Deploy application
    - name: Deploy application
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        echo "ğŸš€ Starting deployment..."

        PROJECT_DIR=/var/www/crm

        # Ensure swap exists (helps npm builds on small instances)
        if [ ! -f /swapfile ]; then
          echo "ğŸ’¾ Creating swapfile..."
          if ! sudo fallocate -l 2G /swapfile 2>/dev/null; then
            sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
          fi
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile || true
        fi

        # Create project directory if missing
        [ ! -d "$PROJECT_DIR" ] && sudo mkdir -p "$PROJECT_DIR" && sudo chown ubuntu:ubuntu "$PROJECT_DIR"

        cd "$PROJECT_DIR"

        # Clone repo if not exists, else pull latest changes
        if [ ! -d ".git" ]; then
          echo "ğŸ“¥ Cloning repository..."
          git clone ${{ env.REPO_URL }} .
        else
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
        fi
        echo "ğŸ³ Deploying with Docker Compose..."

        # Ensure Docker is installed
        if ! command -v docker &>/dev/null; then
          echo "ğŸ‹ Docker not found, installing..."
          sudo apt-get update -y
          sudo apt-get install -y docker.io
          sudo systemctl enable --now docker
        fi

        # Ensure docker compose is available (plugin or standalone)
        if docker compose version &>/dev/null; then
          DOCKER_COMPOSE="sudo docker compose"
        elif command -v docker-compose &>/dev/null; then
          DOCKER_COMPOSE="sudo docker-compose"
        else
          echo "ğŸ§© docker compose not found, installing plugin..."
          sudo apt-get update -y
          sudo apt-get install -y docker-compose-plugin
          DOCKER_COMPOSE="sudo docker compose"
        fi

        # Build and start containers
        echo "ğŸ“¦ Building Docker images..."
        $DOCKER_COMPOSE -f docker-compose.yml build

        echo "ğŸš€ Starting containers..."
        $DOCKER_COMPOSE -f docker-compose.yml up -d

        echo "âœ… Docker deployment completed!"
        EOF

        # Copy and execute script on EC2 (run in background with nohup)
        scp -o StrictHostKeyChecking=no -i ec2_key.pem deploy.sh ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }}:/tmp/
        ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -i ec2_key.pem ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }} "chmod +x /tmp/deploy.sh && /tmp/deploy.sh > deploy.log 2>&1"

    # 8ï¸âƒ£ Health check
    - name: Health check
      run: |
        IP=${{ steps.ec2.outputs.EC2_PUBLIC_IP }}

        echo "â³ Waiting for services to start (initial delay)..."
        sleep 120

        echo "ğŸ¥ Checking frontend with retries..."
        MAX_ATTEMPTS=10
        SLEEP_BETWEEN=15
        for i in $(seq 1 $MAX_ATTEMPTS); do
          if curl -f -s http://$IP/ >/dev/null; then
            echo "âœ… Frontend accessible"
            break
          fi
          echo "Frontend attempt $i/$MAX_ATTEMPTS failed, retrying in ${SLEEP_BETWEEN}s..."
          sleep $SLEEP_BETWEEN
          if [ "$i" -eq "$MAX_ATTEMPTS" ]; then
            echo "Frontend down after multiple attempts"
            exit 1
          fi
        done

        echo "ğŸ¥ Checking backend with retries..."
        for i in $(seq 1 $MAX_ATTEMPTS); do
          if curl -f -s http://$IP:5001/api/health >/dev/null; then
            echo "âœ… Backend accessible"
            break
          fi
          echo "Backend attempt $i/$MAX_ATTEMPTS failed, retrying in ${SLEEP_BETWEEN}s..."
          sleep $SLEEP_BETWEEN
          if [ "$i" -eq "$MAX_ATTEMPTS" ]; then
            echo "Backend down after multiple attempts"
            exit 1
          fi
        done

    # 9ï¸âƒ£ Cleanup
    - name: Cleanup
      run: rm -f ec2_key.pem deploy.sh

    # ğŸ”Ÿ Deployment summary
    - name: Deployment summary
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸŒ Frontend: http://${{ steps.ec2.outputs.EC2_PUBLIC_IP }}"
        echo "ğŸ”§ Backend: http://${{ steps.ec2.outputs.EC2_PUBLIC_IP }}/api"
        echo "ğŸ“Š PM2 Status: ssh -i ec2_key.pem ubuntu@${{ steps.ec2.outputs.EC2_PUBLIC_IP }} 'pm2 status'"
