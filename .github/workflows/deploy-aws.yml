name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  AWS_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
  EC2_HOST: ${{ secrets.EC2_HOST }}   # e.g., ubuntu@your-server-ip
  PROJECT_DIR: /home/ubuntu/CRM-100acress

jobs:
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build and push frontend
      - name: Build & Push Frontend
        run: |
          docker login -u $DOCKERHUB_USER -p $DOCKERHUB_TOKEN
          docker build -t $DOCKERHUB_USER/crm-frontend:latest ./acre-flow-crm
          docker push $DOCKERHUB_USER/crm-frontend:latest

      # Build and push backend
      - name: Build & Push Backend
        run: |
          docker login -u $DOCKERHUB_USER -p $DOCKERHUB_TOKEN
          docker build -t $DOCKERHUB_USER/crm-backend:latest ./crm-backend
          docker push $DOCKERHUB_USER/crm-backend:latest

  deploy_frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy frontend on server
        run: |
          echo "$AWS_SSH_KEY" > ec2_key.pem
          chmod 400 ec2_key.pem
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem $EC2_HOST << 'EOF'
            docker pull $DOCKERHUB_USER/crm-frontend:latest
            docker stop crm-frontend || true
            docker rm crm-frontend || true
            docker run -d --name crm-frontend -p 80:80 $DOCKERHUB_USER/crm-frontend:latest
          EOF
          rm -f ec2_key.pem

  deploy_backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy backend on server
        run: |
          echo "$AWS_SSH_KEY" > ec2_key.pem
          chmod 400 ec2_key.pem
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem $EC2_HOST << 'EOF'
            docker pull $DOCKERHUB_USER/crm-backend:latest
            docker stop crm-backend || true
            docker rm crm-backend || true
            docker run -d --name crm-backend -p 5001:5001 $DOCKERHUB_USER/crm-backend:latest
          EOF
          rm -f ec2_key.pem
