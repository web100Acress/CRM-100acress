name: Deploy CRM Frontend & Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Save EC2 SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 400 ec2_key.pem

      # --- Frontend Build & Deploy ---
      - name: Build Frontend Docker Image
        run: docker build -t crm-frontend:latest ./acre-flow-crm

      - name: Deploy Frontend to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            docker stop crm-frontend || true
            docker rm crm-frontend || true
            docker run -d -p 80:80 --name crm-frontend crm-frontend:latest
          EOF

      # --- Backend Build & Deploy ---
      - name: Build Backend Docker Image
        run: docker build -t crm-backend:latest ./crm-backend

      - name: Deploy Backend to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            docker stop crm-backend || true
            docker rm crm-backend || true
            docker run -d -p 5001:5001 --name crm-backend crm-backend:latest
          EOF

      - name: Cleanup SSH Key
        run: rm -f ec2_key.pem
