<!DOCTYPE html>
<html>
<head>
    <title>Chat Functionality Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 5px; margin: 5px; width: 300px; }
        .error { color: red; }
        .success { color: green; }
        .chat-window { width: 400px; height: 300px; border: 1px solid #ccc; margin: 10px 0; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        .message { margin: 5px 0; padding: 8px; border-radius: 10px; max-width: 80%; }
        .me { background: #dcf8c6; margin-left: auto; text-align: right; }
        .other { background: #fff; }
    </style>
</head>
<body>
    <h1>Chat Functionality Test</h1>
    
    <div class="test-section">
        <h3>Test Chat with Current Setup</h3>
        <p>This will test the actual chat functionality with your current user and lead setup.</p>
        <button onclick="testCurrentChat()">Test Current Chat</button>
        <div id="testResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>Chat Preview</h3>
        <div id="chatPreview" class="chat-window"></div>
        <div>
            <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let authToken = '';
        let currentChatId = '';
        let currentUserId = '';
        let messages = [];

        // Auto-login with stored credentials
        window.onload = function() {
            const storedToken = localStorage.getItem('token');
            if (storedToken) {
                authToken = storedToken;
                getCurrentUserInfo();
            } else {
                // Try to login with default credentials
                login('devfoliomarketplace@gmail.com', 'admin123');
            }
        };

        async function login(email, password) {
            try {
                const response = await fetch('https://bcrm.100acress.com/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('token', authToken);
                    getCurrentUserInfo();
                    console.log('✅ Logged in successfully');
                } else {
                    console.error('❌ Login failed:', data.message);
                }
            } catch (error) {
                console.error('❌ Login error:', error);
            }
        }

        async function getCurrentUserInfo() {
            try {
                const tokenPayload = JSON.parse(atob(authToken.split('.')[1]));
                currentUserId = tokenPayload.userId || tokenPayload.id || tokenPayload._id;
                console.log('Current user ID:', currentUserId);
            } catch (error) {
                console.error('Error parsing token:', error);
            }
        }

        async function testCurrentChat() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = 'Testing chat functionality...';
            
            try {
                // Step 1: Get user's leads
                const leadsResponse = await fetch('https://bcrm.100acress.com/api/leads', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!leadsResponse.ok) {
                    throw new Error('Failed to get leads');
                }
                
                const leadsData = await leadsResponse.json();
                const leads = leadsData.data || leadsData;
                
                if (leads.length === 0) {
                    resultDiv.innerHTML = '<span class="error">❌ No leads found for current user</span>';
                    return;
                }
                
                // Get the first lead
                const lead = leads[0];
                console.log('Testing with lead:', lead);
                
                // Step 2: Try to create chat
                const chatData = {
                    leadId: lead._id,
                    createdBy: currentUserId,
                    assignedTo: lead.assignedTo || lead.createdBy || currentUserId
                };
                
                // If assignedTo is same as current user, use another user
                if (chatData.assignedTo === currentUserId) {
                    chatData.assignedTo = lead.createdBy;
                    if (chatData.assignedTo === currentUserId) {
                        resultDiv.innerHTML = '<span class="error">❌ Cannot determine chat recipient (self-assignment)</span>';
                        return;
                    }
                }
                
                const chatResponse = await fetch('https://bcrm.100acress.com/api/chats/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(chatData)
                });
                
                const chatResult = await chatResponse.json();
                
                if (chatResponse.ok && chatResult.success) {
                    currentChatId = chatResult.data._id;
                    resultDiv.innerHTML = `<span class="success">✅ Chat created successfully!</span>
Chat ID: ${currentChatId}
Lead: ${lead.name}
Participants: You ↔ ${chatResult.data.participants?.map(p => p.name).join(' ↔ ') || 'Unknown'}
Initial Messages: ${chatResult.data.messages?.length || 0}`;
                    
                    // Load messages
                    loadMessages();
                } else {
                    resultDiv.innerHTML = `<span class="error">❌ Failed to create chat</span>
${JSON.stringify(chatResult, null, 2)}`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }

        async function loadMessages() {
            if (!currentChatId) return;
            
            try {
                const response = await fetch(`https://bcrm.100acress.com/api/chats/messages?chatId=${currentChatId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (response.ok && data.success) {
                    messages = data.data;
                    displayMessages();
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function displayMessages() {
            const chatWindow = document.getElementById('chatPreview');
            chatWindow.innerHTML = messages.map(msg => {
                const isMe = String(msg.senderId?._id || msg.senderId) === String(currentUserId);
                const className = isMe ? 'message me' : 'message other';
                const senderName = isMe ? 'You' : (msg.senderId?.name || 'Unknown');
                return `
                    <div class="${className}">
                        <div><strong>${senderName}:</strong> ${msg.message}</div>
                        <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentChatId) return;
            
            try {
                const response = await fetch('https://bcrm.100acress.com/api/chats/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        message: message,
                        senderId: currentUserId
                    })
                });
                
                const data = await response.json();
                if (response.ok && data.success) {
                    input.value = '';
                    // Reload messages
                    setTimeout(loadMessages, 500);
                } else {
                    console.error('Failed to send message:', data);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }
    </script>
</body>
</html>
